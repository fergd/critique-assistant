<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Critique Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Orienta&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
      --default-font: 'Plus Jakarta Sans','Orienta',  sans-serif;
      --main-bg-color: white;
      --card-surface: white;
      --text: black;
      --borders: black;
      --highlights: yellow;
      --button-bg: black;
      --accent-color: yellow;
      --button-primary-bg: white;
      --button-primary-text: black;
      --button-primary-border: black;
      --button-primary-shadow: black;
      --border-radius: 11px;
      --default-padding: 11px;
      --default-margin: 15px;
    }

    body {
      font-family: var(--default-font);
      font-weight: 800;
      padding: var(--default-padding);
      background: var(--main-bg-color);
      color: var(--text);
    }

    button, textarea {
      border-radius: var(--border-radius);
      padding: var(--default-padding);
      font-family: inherit;
      font-weight: 800;
    }

    .primary-button {
      font-size: 21px;
      width: 100%;
      margin: 21px 0;
      background: var(--button-primary-bg);
      color: var(--button-primary-text);
      border: 2px solid var(--button-primary-border);
      box-shadow: -6px 6px 0 var(--button-primary-shadow);
      cursor: pointer;
    }

    .primary-button:hover {
      background: var(--accent-color);
    }

    .badge {
      padding: 2px 6px;
      font-size: 0.85em;
      border-radius: var(--border-radius);
      display: inline-block;
    }

    .high { background-color: red; color: white; }
    .medium { background-color: orange; color: black; }
    .low { background-color: lightgreen; color: black; }

    .card {
      background: var(--card-surface);
      border-radius: var(--border-radius);
      margin-bottom: 19px;
      padding: 19px;
      border: 1px solid black;
      box-shadow: -6px 6px 0 var(--button-primary-border);
    }

    textarea {
      width: 100%;
      min-height: 100px;
      margin-bottom: 10px;
    }

    section {
      display: none;
    }

    .spinner:after {
      content: " ";
      display: block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 3px solid #ccc;
      border-color: #ccc transparent #ccc transparent;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0); }
      100% { transform: rotate(360deg); }
    }

    .show-button {
  font-size: 16px;
  padding: 8px 14px;
  margin-top: 10px;
  border: 2px solid var(--button-primary-border);
  background: var(--button-primary-bg);
  color: var(--button-primary-text);
  font-weight: 800;
  font-family: inherit;
  border-radius: var(--border-radius);
  cursor: pointer;
  box-shadow: -4px 4px 0 var(--button-primary-shadow);
  transition: background 0.2s ease, transform 0.1s ease;
}

.show-button:hover {
  background: var(--accent-color);
}

.show-button:active {
  transform: translateY(1px);
  box-shadow: -2px 2px 0 var(--button-primary-shadow);
}
.switch-container {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 8px;
  font-size: 16px;
  font-weight: 800;
  font-family: var(--default-font);
}

.switch-container input {
  display: none;
}

.switch-slider {
  width: 46px;
  height: 26px;
  border-radius: var(--border-radius);
  border: 2px solid var(--button-primary-border);
  background-color: var(--button-primary-bg);
  box-shadow: -3px 3px 0 var(--button-primary-shadow);
  position: relative;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.switch-slider::before {
  content: "";
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: var(--button-primary-text);
  border-radius: 50%;
  transition: transform 0.2s ease;
}

.switch-container input:checked + .switch-slider::before {
  transform: translateX(20px);
}

.switch-container input:checked + .switch-slider {
  background-color: var(--accent-color);
}
.feedback-button {
  display: inline-block;
  text-align: center;
  font-size: 18px;
  font-weight: 800;
  margin-top: 8px;
  padding: 10px 16px;
  border: 2px solid var(--button-primary-border);
  background: var(--button-primary-bg);
  color: var(--button-primary-text);
  text-decoration: none;
  border-radius: var(--border-radius);
  box-shadow: -4px 4px 0 var(--button-primary-shadow);
  transition: background 0.2s ease, transform 0.1s ease;
}

.feedback-button:hover {
  background: var(--accent-color);
}

.feedback-button:active {
  transform: translateY(1px);
  box-shadow: -2px 2px 0 var(--button-primary-shadow);
}
#resetBtn {
  background: #f5f5f5;
  color: black;
}

.icon-left {
  margin-right: 10px;
  font-size: 0.9em;
}

  </style>
</head>

<body>
    <h2>Critique Assistant</h2>
    <section id="before-container">
        <label for="context">Design Context</label><br>
        <small style="color: dimgray;">Optional</small>
        <br><br>
        <textarea id="context" placeholder="e.g. Onboarding flow for new manager..."></textarea>
        <button id="analyzeBtn" class="primary-button">Start critique</button>
        <label class="switch-container">
            <input type="checkbox" id="ignoreRepeated">
            <span class="switch-slider"></span>
            <span class="switch-label">Ignore repeated text</span>
        </label>
        <br><br>
    </section>
    <section id="analyzing-container">
        <div class="spinner"></div>
        <div id="loading">Preparing…</div>
        <div id="frameCount" style="margin-top: 6px; font-size: 0.9em;"></div>
        <button id="cancelBtn" class="primary-button">Cancel</button>
    </section>
    <section id="results-container">
        <div id="output"></div>
        <div style="display: flex; gap: 12px; flex-wrap: no-wrap; flex-direction: row;">
            <button id="restartBtn" class="primary-button">Critique again</button>
            <button id="resetBtn" class="primary-button" style="background: var(--button-primary-bg);">Reset</button>
        </div>
    </section>
    <hr>
    <p>The results aren't going to be perfect...yet. Let me know how it works for you so I can make it better.</p>
    <a id="feedbackLink" href="https://docs.google.com/forms/d/e/1FAIpQLSeiEdlkZuhvXbFVhnlFoh9Sc_nvKQzE_-nTNou0XPfBci213w/viewform?usp=dialog" target="_blank" rel="noopener" class="feedback-button" style="display: none;">Give Feedback
    </a>
   <script>
    const proxyEndpoint = "https://critique-assistant-proxy-68s30gi3o-christans-projects-b1d924ef.vercel.app/api/proxy";
    let cancelRequested = false;
    let currentDesignData = null;

  const highlightNode = nodeId => {
    parent.postMessage({ pluginMessage: { type: "highlight", nodeId } }, "*");
  };

  const setVisibleSection = id => {
    ["before-container", "analyzing-container", "results-container"].forEach(s =>
      document.getElementById(s).style.display = (s === id) ? "block" : "none"
    );
  };

  const extractNodeId = location => {
    const match = location?.match(/nodeId[:\s]+([\w:\-;]+)/i);
    return match ? match[1] : null;
  };

  let nodeTextMap = {};
  const buildNodeTextMap = (nodes) => {
    nodes.forEach(node => {
      if (node.type === "TEXT" && node.characters) {
        nodeTextMap[node.nodeId] = node.characters.trim().toLowerCase();
      }
      if (node.children) buildNodeTextMap(node.children);
    });
  };

  const deduplicateViolations = (violations, ignoreRepeated, designData) => {
    if (!ignoreRepeated) return violations;
    nodeTextMap = {};
    if (designData) buildNodeTextMap(designData);

    const seen = new Set();
    return violations.filter(v => {
      const textContent = nodeTextMap[v.nodeId] || "";
      const isTextViolation = textContent && (
        v.trap_name === "Memory Challenge" ||
        v.trap_name === "Uncomprehended Element" ||
        v.trap_name === "Effectively Invisible Element" ||
        v.impact?.toLowerCase().includes("text") ||
        v.impact?.toLowerCase().includes("label")
      );
      if (!isTextViolation) return true;

      const key = `${v.trap_name || ""}::${textContent}`;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });
  };

  const renderIssues = issues => {
    if (!Array.isArray(issues) || issues.length === 0) {
      return `<div style="color:MediumSeaGreen;"><strong>No issues found 🎉</strong></div>`;
    }

    return issues.map(i => {
      const name =
        i.trap_name?.trim() ||
        i.violation?.trim() ||
        i.title?.trim() ||
        i.description?.split(".")[0]?.trim() ||
        "Unnamed Violation";

      const impact = i.impact || i.violation_impact || "No impact explanation provided.";
      const nodeId = extractNodeId(i.location) || i.nodeId || null;

      return `
        <div class="card">
          <h4>${name}</h4>
          <p>${impact}</p>
          ${nodeId
            ? `<button class="show-button" onclick="highlightNode('${nodeId}')">Show me</button>`
            : `<small style="color:gray;">(No location info)</small>`}
        </div>
      `;
    }).join("");
  };

  const extractValidJson = text => {
    try {
      const cleaned = text.replace(/^```(?:json)?/i, '').replace(/```$/, '').trim();
      if (cleaned.startsWith("[")) return JSON.parse(cleaned);
      const parsed = JSON.parse(cleaned);
      if (Array.isArray(parsed.violations)) return parsed.violations;
      if (Array.isArray(parsed)) return parsed;
      throw new Error("Parsed response is not a valid JSON array.");
    } catch (err) {
      console.error("❌ JSON parse error:", err, "\nRaw content:\n", text);
      throw new Error("Assistant did not return valid JSON.");
    }
  };

  document.getElementById("analyzeBtn").onclick = () => {
    cancelRequested = false;
    setVisibleSection("analyzing-container");
    document.getElementById("output").innerHTML = "";
    document.getElementById("loading").innerText = "Starting analysis...";
    parent.postMessage({ pluginMessage: { type: "trigger-analysis" } }, "*");
  };

  document.getElementById("restartBtn").onclick = () => {
    cancelRequested = false;
    setVisibleSection("analyzing-container");
    document.getElementById("output").innerHTML = "";
    document.getElementById("loading").innerText = "Restarting analysis...";
    parent.postMessage({ pluginMessage: { type: "trigger-analysis" } }, "*");
  };

  document.getElementById("resetBtn").onclick = () => {
    cancelRequested = false;
    setVisibleSection("before-container");
    document.getElementById("context").value = "";
    document.getElementById("output").innerHTML = "";
    document.getElementById("ignoreRepeated").checked = false;
  };

  document.getElementById("cancelBtn").onclick = () => {
    cancelRequested = true;
    setVisibleSection("before-container");
    document.getElementById("output").innerHTML =
      `<div style="color:orange;"><strong>Analysis cancelled.</strong></div>`;
  };

  window.onload = () => setVisibleSection("before-container");

  window.onmessage = async event => {
    const data = event.data.pluginMessage;
    if (!data || data.type !== "design-data") return;

    try {
      currentDesignData = data.payload;

      const context = document.getElementById("context").value;
      const ignoreRepeated = document.getElementById("ignoreRepeated").checked;
      const payload = { design: currentDesignData, context, ignoreRepeated };

      const response = await fetch(proxyEndpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      if (!result.content) throw new Error("No content returned from proxy.");

      const parsed = extractValidJson(result.content);
      const filtered = deduplicateViolations(parsed, ignoreRepeated, currentDesignData);
      document.getElementById("output").innerHTML = renderIssues(filtered);

      setVisibleSection("results-container");

    } catch (err) {
      console.error("❌ Proxy error:", err);
      document.getElementById("output").innerHTML =
        `<div style="color:red;">
          <strong>Error:</strong> ${err.message}<br />
          <pre style="white-space: pre-wrap; font-size: 0.85em;">${err.stack}</pre>
        </div>`;
      setVisibleSection("results-container");
    }
  };
</script>

</body>

</html>