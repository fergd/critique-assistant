<!DOCTYPE html>
<html>
<head>
    <title>Critique Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,600;0,800;1,400;1,600;1,800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
    :root {
        --midnight: #1a0f3d;
        --midnight-light: #8d879e;
        --twilight: #3b2471;
        --twilight-light: #9d92b8;
        --amethyst: #7E3DD4;
        --amethyst-light: #bf9eea;
        --orchid: #b845c7;
        --orchid-light: #dca2e3;
        --fuchsia: #e24ba6;
        --fuchsia-light: #f1a5d3;
        --sunset: #ff5d7a;
        --sunset-light: #ffaebd;
        --tangerine: #ff7c4f;
        --tangerine-light: #ffbea7;
        --amber: #ffa600;
        --amber-light: #ffd380;
        --snow: #ffffff;
        --mint: #C1EA9E;
        --dark-mint: #65CF47;

        --base-font-size: 15px;
        --font-family: "Plus Jakarta Sans", -apple-system, BlinkMacSystemFont, sans-serif;

        --ms3: 3.375rem;
        --ms2: 2.25rem;
        --ms1: 1.5rem;
        --ms0: 1rem;
        --ms-1: 0.667rem;

        --font-size-heading: var(--ms1);
        --font-size-body: var(--ms0);
        --font-size-small: var(--ms-1);
        --font-heavy: 800;
        --font-normal: 600;

        --padding-large: var(--ms2);
        --padding-medium: var(--ms1);
        --padding-small: var(--ms0);
        --padding-tiny: var(--ms-1);
        --spacing-large: var(--ms3);
        --spacing-medium: var(--ms0);
        --spacing-small: var(--ms-1);

        --button-shadow-offset: -4px 4px 0;
        --button-shadow-bolder: -7px 7px 0;

        --default-weight: 4px;
        --default-radius: 11px;
        --default-border: var(--default-weight) solid var(--midnight);
        --border-subdued: var(--default-weight) solid var(--midnight-light);
        --shadow-bold: var(--button-shadow-offset) var(--midnight);
        --shadow-subdued: var(--button-shadow-offset) var(--midnight-light);
        --shadow-bold: var(--button-shadow-bolder) var(--midnight);

        --app-bg: var(--snow);
        --text-primary: var(--twilight);
        --text-secondary: var(--midnight-light);
    }

    *, *::before, *::after {
        box-sizing: border-box;
    }

    html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
        margin: 0;
        padding: 0;
        border: 0;
        font-size: 100%;
        font: inherit;
        vertical-align: baseline;
    }

    article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section {
        display: block;
    }

    body {
        line-height: 1;
    }

    blockquote, q {
        quotes: none;
    }

    blockquote:before, blockquote:after, q:before, q:after {
        content: '';
        content: none;
    }

    table {
        border-collapse: collapse;
        border-spacing: 0;
    }
    strong {
        font-weight: bolder;
    }
    ul {
        list-style: none;
    }

    html {
        font-size: var(--base-font-size);
        background: var(--midnight);
    }

    body {
        font-size: 100%;
        font-family: var(--font-family);
        font-weight: var(--font-heavy);
        margin: 0 auto;
        min-height: 100vh;
        width: 580px;
        background: var(--app-bg);
        color: var(--text-primary);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
    }

    small {
        font-size: var(--ms-1);
        color: var(--text-secondary);
    }

    header {
        margin-bottom: var(--padding-large);
    }

    h1 {
        font-size: var(--ms2);
        display: flex;
        flex-direction: row;
        align-items: center;
    }

    i.heading-icon {
        color: var(--sunset);
        font-size: var(--ms1);
    }

    h2 {
        font-size: var(--ms1);
        margin-bottom: var(--padding-small);
    }
    
    p {
        margin-bottom: var(--padding-tiny);
        line-height: 1.2;
    }
    
    p.subtitle {
        color: var(--text-secondary);
    }

    a {
        color: var(--amethyst);
        text-decoration: none;
    }

    a:hover {
        text-decoration: underline;
    }

    .basic-button {
        text-decoration: none;
        cursor: pointer;
        font-family: var(--font-family);
        font-size: var(--font-size-body);
        font-weight: 800;
        padding: var(--padding-small);
        background: var(--snow);
        color: var(--text-primary);
        box-shadow: var(--shadow-bold);
        border: var(--default-border);
        border-radius: var(--default-radius);
        transition: all 0.15s ease;
        white-space: nowrap;
        will-change: transform, background-color;
    }

    button.basic-button:hover {
        background: var(--amber);
        transform: translateY(-1px);
    }

    button.basic-button:active {
        box-shadow: none;
        transform: translateY(0);
    }

    button.basic-button.disabled {
        background: var(--amber-light);
        cursor: not-allowed;
        color: var(--midnight-light);
        border: var(--border-subdued);
        box-shadow: var(--shadow-bold);
    }

    .app-container {
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: var(--padding-large);
        overflow: auto;
        contain: layout style;
    }

    .footer {
        padding: var(--padding-medium) 0;
        border-top: 2px dashed var(--twilight-light);
        display: flex;
        flex-direction: row;
        gap: var(--spacing-medium);
        justify-content: space-between;
        align-items: center;
    }

    .footer p {
        color: var(--text-secondary);
        font-weight: var(--font-heavy);
    }

    .feedback-button {
        flex-grow: 2;
    }

    .item {
        border: var(--default-weight) solid var(--midnight-light);
        border-radius: var(--default-radius);
        padding: var(--padding-medium);
        margin-bottom: var(--spacing-medium);
    }

    .item .step-label {
        font-size: var(--ms1);
    }

    .form-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-medium);
    }

    .frame-select {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
    }

    .frame-select i.step-icon {
        font-size: var(--font-size-heading);
        color: var(--amethyst);
    }

    .frame-select-invalid i.step-icon {
        display: none;
    }

    .frame-select-valid i.step-icon {
        display: block;
    }

    .add-context {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-medium);
    }

    .add-context div:nth-of-type(even) {
        border-radius: var(--default-radius);
        padding: var(--padding-medium) 0 0 0;
    }

    .api-key-section {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-medium);
    }

    .api-key-input-container {
        display: flex;
        flex-direction: row;
        gap: var(--spacing-small);
        align-items: center;
    }

    input.api-key-input {
        font-weight: 600;
        flex: 1;
        padding: var(--padding-small);
        border: var(--default-border);
        border-color: var(--midnight-light);
        border-radius: var(--default-radius);
        background: var(--snow);
        font-family: var(--font-family);
        font-size: var(--font-size-body);
        color: var(--text-primary);
        transition: border-color 0.15s ease;
    }

    input.api-key-input:focus {
        outline: none;
        border-color: var(--amethyst);
    }

    input.api-key-input.valid {
        border-color: var(--dark-mint);
    }

    input.api-key-input.invalid {
        border-color: var(--sunset);
    }

    input.api-key-input::placeholder {
        color: var(--text-secondary);
    }

    .api-key-status {
        min-width: 24px;
        text-align: center;
    }

    .api-key-status i {
        font-size: var(--ms1);
    }

    .api-key-status.valid i {
        color: var(--dark-mint);
    }

    .api-key-status.invalid i {
        color: var(--sunset);
    }

    .api-key-help {
        font-size: var(--ms-1);
        color: var(--text-secondary);
        line-height: 1.3;
    }

    textarea.context-input {
        font-weight: 600;
        width: 100%;
        min-height: 60px;
        border: none;
        outline: none;
        background: transparent;
        font-family: var(--font-family);
        font-size: var(--font-size-body);
        color: var(--text-primary);
        resize: none;
    }

    textarea::placeholder {
        color: var(--text-secondary);
    }

    .toggle-section {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .toggle-button {
        border: var(--default-border);
        border-color: var(--twilight-light);
        border-radius: var(--default-radius);
        cursor: pointer;
        transition: all 0.15s ease;
        padding: 7px 33px 7px 7px;
        will-change: transform, background-color;
    }

    .toggle-button.checked {
        padding: 7px 7px 7px 33px;
        background: var(--amber);
        border-color: var(--midnight);
    }

    .toggle-icon::before {
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        font-size: var(--ms1);
        content: '\f111';
    }

    .toggle-button.checked .toggle-icon::before {
        content: '\f058';
    }

    .cta-container {
        text-align: center;
        padding-top: var(--padding-medium);
    }

    .cta-button {
        margin: 0 auto;
        font-family: var(--font-family);
        font-size: var(--font-size-heading);
        font-weight: var(--font-heavy);
        padding: var(--padding-medium);
        box-shadow: var(--shadow-bold);
        border-radius: var(--default-radius);
        cursor: not-allowed;
        transition: all 0.15s ease;
        will-change: transform, background-color;
    }

    .cta-button.disabled {
        background: var(--amber-light);
        color: var(--midnight-light);
        border: var(--border-subdued);
    }

    .cta-button.disabled i {
        color: var(--sunset-light);
    }

    .cta-button.enabled {
        background: var(--amber);
        color: var(--midnight);
        border: var(--default-border);
        box-shadow: var(--shadow-bold);
        cursor: pointer;
    }

    .cta-button.enabled i {
        color: var(--midnight);
    }

    .cta-button.enabled:hover {
        transform: translateY(-2px);
        box-shadow: var(--button-shadow-bolder) var(--midnight);
    }

    .cta-button.enabled:active {
        box-shadow: none;
        transform: translateY(0);
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--padding-large);
        text-align: center;
    }

    .spinner {
        display: grid;
        grid-template-columns: repeat(3, 30px);
        grid-template-rows: repeat(3, 30px);
        gap: 6px;
        margin: var(--padding-large) 0 0 0;
        contain: layout style;
    }

    .spinner-box {
        width: 36px;
        height: 36px;
        background: var(--snow);
        border: var(--default-border);
        border-radius: 6px;
        transition: background-color 0.2s ease;
        will-change: background-color;
    }

    .spinner-box.active {
        background: var(--sunset);
    }

    .status-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-medium);
        margin-top: var(--spacing-large);
    }

    .status-item {
        display: flex;
        align-items: center;
        flex-direction: row;
        gap: var(--spacing-small);
        contain: layout style;
    }

    .status-item::before {
        content: '';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        font-size: var(--ms1);
        color: var(--midnight);
        width: 20px;
        flex-shrink: 0;
    }

    .status-item.complete .status-text {
        color: var(--midnight);
    }

    .status-item.complete::before {
        content: '\f058';
    }

    .status-item.in-progress .status-text {
        color: var(--sunset);
    }

    .status-item.in-progress::before {
        content: '\e2ca';
        color: var(--sunset);
    }

    .status-item.waiting .status-text {
        color: var(--twilight-light);
    }

    .status-item.waiting::before {
        content: '\e2ca';
        color: var(--twilight-light);
        visibility: hidden;
    }

    .results-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-small);
        margin-bottom: var(--padding-medium);
    }
    
    .results-content {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-small);
        contain: layout;
    }

    .violation-card {
        display: flex;
        flex-direction: column;
        gap: 0;
        border: var(--border-subdued);
        border-radius: var(--default-radius);
        margin-bottom: var(--spacing-small);
        will-change: transform;
        contain: layout style;
    }

    .violation-card-header {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
        padding: var(--padding-small);
        background: var(--snow);
        border-radius: var(--default-radius) var(--default-radius) 0 0;
        margin: 0;
    }

    .violation-header-left {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-medium );
        flex-grow: 1;
        min-width: 0;
    }

    .violation-title {
        font-size: var(--ms1);
        color: var(--twilight);
        margin: 0;
        font-weight: var(--font-heavy);
        word-wrap: break-word;
    }

    .violation-meta {
        display: flex;
        flex-direction: row;
        gap: var(--spacing-small);
        align-items: center;
        flex-wrap: wrap;
    }

    .severity-badge {
        font-size: var(--ms-1);
        font-weight: var(--font-heavy);
        padding: 3px 8px;
        border-radius: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 2px solid;
        white-space: nowrap;
    }

    .severity-critical {
        background: var(--sunset-light);
        color: var(--sunset);
        border-color: var(--sunset);
    }

    .severity-important {
        background: var(--tangerine-light);
        color: var(--tangerine);
        border-color: var(--tangerine);
    }

    .severity-minor {
        background: var(--amber-light);
        color: var(--amber);
        border-color: var(--amber);
    }

    .tenet-badge {
        font-size: var(--ms-1);
        font-weight: var(--font-normal);
        color: var(--twilight);
        background: var(--amethyst-light);
        border: 2px solid var(--amethyst);
        padding: 3px 8px;
        border-radius: 6px;
        white-space: nowrap;
    }

    .violation-header-right {
        display: flex;
        align-items: flex-start;
        margin-left: var(--spacing-small);
        flex-shrink: 0;
    }

    .focus-button {
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: var(--ms1);
        padding: 8px;
        background: var(--snow);
        border-radius: var(--default-radius);
        border: var(--default-border);
        box-shadow: var(--shadow-bold);
        transition: all 0.1s ease;
        color: var(--twilight);
        will-change: transform, background-color, box-shadow;
        contain: layout style;
        min-width: 44px;
        min-height: 44px;
    }

    .focus-button:hover {
        background: var(--amber-light);
        transform: translateY(-1px);
    }

    .focus-button:active {
        background: var(--amber);
        box-shadow: none;
        transform: translateY(0);
    }

    .focus-button.processing {
        background: var(--orchid-light);
        cursor: wait;
        animation: pulse 0.8s infinite ease-in-out;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .violation-content {
        padding: var(--padding-small);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-small);
    }

    .violation-summary {
        font-size: var(--font-size-body);
        color: var(--text-primary);
        font-weight: 600;
        line-height: 1.4;
        margin: 0;
    }

    .violation-summary strong {
        font-weight: var(--font-heavy);
    }

    .violation-details {
        font-size: var(--font-size-body);
        color: var(--text-primary);
        font-weight: 500;
        line-height: 1.3;
        margin: 0;
    }

    .violation-details strong {
        font-weight: var(--font-heavy);
    }

    .violation-impact {
        font-size: var(--font-size-body);
        color: var(--text-primary);
        font-weight: 500;
        line-height: 1.3;
        margin: 0;
    }

    .violation-impact strong {
        font-weight: var(--font-heavy);
    }

    .violation-context {
        font-size: var(--font-size-body);
        color: var(--text-primary);
        margin-top: var(--spacing-small);
        padding: var(--padding-tiny);
        background: var(--snow);
        border-left: 3px solid var(--twilight-light);
    }

    .violation-recommendation {
        font-size: var(--font-size-body);
        color: var(--text-primary);
        font-weight: 500;
        line-height: 1.3;
        margin: 0;
    }

    .violation-recommendation strong {
        font-weight: var(--font-heavy);
    }

    .trap-reference {
        font-size: var(--font-size-body);
        color: var(--text-primary);
        font-weight: var(--font-normal);
        background: var(--snow);
    }

    .results-card {
        display: flex;
        flex-direction: column;
        gap: 0;
        border: var(--border-subdued);
        border-radius: var(--default-radius);
    }

    header.results-card-header {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        padding: var(--padding-tiny) var(--padding-small);
        color: var(--midnight);
        border-radius: var(--default-radius) var(--default-radius) 0 0;
        margin: 0;
    }

    .results-card.nothing-returned {
        border-color: var(--dark-mint);
    }

    .nothing-returned header.results-card-header {
        background: var(--mint);
    }

    .results-card.error {
        border-color: var(--tangerine);
    }

    .results-card.error header.results-card-header {
        background: var(--tangerine-light);
    }

    header.results-card-header h3 {
        font-size: var(--ms1);
        color: var(--twilight);
        margin-bottom: var(--padding-tiny);
    }

    .results-card .content {
        padding: var(--padding-small);
        font-size: var(--font-size-body);
        color: var(--text-primary);
        font-weight: 500;
        line-height: 1.3;
    }

    .crit-actions-container {
        margin: var(--spacing-medium) 0;
        display: flex;
        flex-direction: row;
        gap: var(--spacing-large);
    }

    .hidden {
        display: none !important;
    }

    /* PERFORMANCE OPTIMIZATIONS */
    .spinner-box, .focus-button, .cta-button, .toggle-button {
        transform: translateZ(0);
        backface-visibility: hidden;
    }

    .violation-card, .status-item {
        contain: layout style;
    }
    </style>
</head>

<body>
    <div class="app-container">
        <div>
            <div id="phaseOne" class="form-container">
                <header>
                    <h1><i class="heading-icon fas fa-wand-magic-sparkles"></i>&nbsp;Critique assistant</h1>
                </header>
                
                <!-- API Key Section -->
                <div class="item api-key-section" id="apiKeySection">
                    <div>
                        <p class="step-label">OpenAI API Key</p>
                        <small>Required - Your key is stored securely in your browser</small>
                    </div>
                    <div class="api-key-input-container">
                        <input type="password" class="api-key-input" id="apiKeyInput" 
                               placeholder="sk-proj-... or sk-...">
                        <div class="api-key-status" id="apiKeyStatus">
                            <i class="fas fa-circle" style="color: var(--midnight-light);"></i>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer; font-size: var(--ms-1);">
                            <input type="checkbox" id="rememberApiKey" checked style="margin-right: 8px;">
                            <span>Remember this API key for future sessions</span>
                        </label>
                    </div>
                    <div class="api-key-help">
                        <p>Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>. Modern keys start with "sk-proj-". Your key is encrypted and stored locally.</p>
                        <p id="apiKeyError" class="api-key-error hidden" style="color: var(--sunset); font-size: var(--ms-1); margin-top: 8px;"></p>
                    </div>
                </div>
                
                <!-- Frame Selection -->
                <div class="item frame-select frame-select-invalid" id="selectFrame">
                    <div>
                        <p class="step-label">Select frames</p>
                        <small>Required</small>
                    </div>
                    <div>
                        <i class="step-icon fas fa-check-circle"></i>
                    </div>
                </div>
                
                <!-- Context Input -->
                <div class="item add-context" id="addContext">
                    <div>
                        <p class="step-label">Add context</p>
                        <small>Optional</small>
                    </div>
                    <div>
                        <textarea class="context-input" id="contextInput" placeholder="Tell the AI what to focus on (e.g., 'Check mobile usability and accessibility')..."></textarea>
                    </div>
                </div>
                
                <!-- Toggle Section -->
                <div class="item toggle-section" id="toggleSection">
                    <div>
                        <p class="step-label">Ignore repeated text</p>
                        <small>Optional</small>
                    </div>
                    <div class="toggle-button" id="toggleContainer">
                        <i class="toggle-icon"></i>
                    </div>
                </div>
                
                <!-- CTA Button -->
                <div class="cta-container">
                    <button class="cta-button disabled" id="ctaButton">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        <span>Start critique</span>
                    </button>
                </div>
            </div>
            
            <div id="phaseTwo" class="loading-container hidden">
                <header>
                    <h2>Analyzing your design</h2>
                    <p class="subtitle">Using your OpenAI API key to analyze the selected frames...</p>
                </header>
                <div class="spinner" id="spinner">
                    <div class="spinner-box"></div>
                    <div class="spinner-box"></div>
                    <div class="spinner-box"></div>
                    <div class="spinner-box"></div>
                    <div class="spinner-box"></div>
                    <div class="spinner-box"></div>
                    <div class="spinner-box"></div>
                    <div class="spinner-box"></div>
                    <div class="spinner-box"></div>
                </div>
                <div class="status-list">
                    <div class="status-item waiting" id="status1">
                        <div class="status-text">Extracting design elements</div>
                    </div>
                    <div class="status-item waiting" id="status2">
                        <div class="status-text">Serializing design nodes</div>
                    </div>
                    <div class="status-item waiting" id="status3">
                        <div class="status-text">Sending to OpenAI for analysis</div>
                    </div>
                    <div class="status-item waiting" id="status4">
                        <div class="status-text">Processing UX critique</div>
                    </div>
                </div>
            </div>
            
            <div id="phaseThree" class="results-container hidden">
                <header>
                    <h1><i class="heading-icon fas fa-wand-magic-sparkles"></i>&nbsp;Results</h1>
                </header>
                <div id="resultsContent" class="results-content"></div>
                <div class="crit-actions-container">
                    <button class="basic-button" id="startOverButton">
                        <span>Start over</span>
                    </button>
                    <button class="basic-button" id="critiqueAgainButton">
                        <span>Critique again</span>
                    </button>
                </div>
                <footer id="globalFooter" class="footer">
                    <p>Your API key is used securely to provide AI-powered UX analysis.</p>
                    <a class="feedback-button basic-button" href="https://forms.gle/NDnGg7RVjf4biB6g8" target="_blank">Give feedback</a>
                </footer>
            </div>
        </div>
    </div>

    <script>
// SECURITY: Simple encryption for API key storage
function encryptApiKey(key) {
  const secretKey = 'CritiqueAssistant2024';
  let encrypted = '';
  for (let i = 0; i < key.length; i++) {
    encrypted += String.fromCharCode(key.charCodeAt(i) ^ secretKey.charCodeAt(i % secretKey.length));
  }
  return btoa(encrypted);
}

function decryptApiKey(encryptedKey) {
  try {
    const secretKey = 'CritiqueAssistant2024';
    const encrypted = atob(encryptedKey);
    let decrypted = '';
    for (let i = 0; i < encrypted.length; i++) {
      decrypted += String.fromCharCode(encrypted.charCodeAt(i) ^ secretKey.charCodeAt(i % secretKey.length));
    }
    return decrypted;
  } catch (e) {
    return null;
  }
}

// COMPREHENSIVE UX ANALYSIS PROMPT - Built into the plugin
const UX_ANALYSIS_PROMPT = `You are an expert UX analyst trained in usability heuristics and design principles. 

Analyze the provided Figma design data and identify usability issues based on:

1. Jakob Nielsen's 10 Usability Heuristics
2. The 9 UX Tenets: Understandable, Habituating, Comfortable, Responsive, Efficient, Forgiving, Discreet, Protective, Beautiful
3. The 24 UX Traps: Memory Challenge, Forced Syntax, Inviting Dead End, Uncomprehended Element, Invisible Element, Poor Grouping, Feedback Failure, Distraction, Effectively Invisible Element, Ambiguous Home, Gratuitous Redundancy, Inconsistent Appearance, Variable Outcome, Wandering Element, Physical Challenge, Accidental Activation, Slow or No Response, Captive Wait, Unnecessary Step, System Amnesia, Irreversible Action, Unwanted Disclosure, Data Loss, Unattractive Appearance

CRITICAL: Return ONLY valid JSON array format. No markdown, no explanations, just JSON.

For each issue found, return this exact structure:
{
  "title": "Brief issue title",
  "description": "Detailed description of the problem",
  "severity": "critical|important|minor", 
  "principleViolation": "Tenet: Trap - Description",
  "userImpact": "How this affects users",
  "recommendation": "Specific fix suggestions",
  "location": "Design hierarchy path if identifiable"
}

If no issues found, return: []

Focus on: accessibility, consistency, usability patterns, information architecture, and user flow issues. Pay special attention to the user context provided.`;

// STATE MANAGEMENT
const STATE = {
  selectedFrames: [],
  context: '',
  ignoreRepeatedText: false,
  analysisInProgress: false,
  currentPhase: 'phaseOne',
  apiKey: ''
};

// DOM ELEMENTS
const DOM = {
  phaseOne: document.getElementById('phaseOne'),
  phaseTwo: document.getElementById('phaseTwo'),
  phaseThree: document.getElementById('phaseThree'),
  apiKeyInput: document.getElementById('apiKeyInput'),
  apiKeyStatus: document.getElementById('apiKeyStatus'),
  apiKeyError: document.getElementById('apiKeyError'),
  rememberApiKey: document.getElementById('rememberApiKey'),
  selectFrame: document.getElementById('selectFrame'),
  contextInput: document.getElementById('contextInput'),
  toggleContainer: document.getElementById('toggleContainer'),
  ctaButton: document.getElementById('ctaButton'),
  spinner: document.getElementById('spinner'),
  status1: document.getElementById('status1'),
  status2: document.getElementById('status2'),
  status3: document.getElementById('status3'),
  status4: document.getElementById('status4'),
  resultsContent: document.getElementById('resultsContent'),
  startOverButton: document.getElementById('startOverButton'),
  critiqueAgainButton: document.getElementById('critiqueAgainButton')
};

let loadingAnimation = null;
let inputDebounce = null;
let apiKeyDebounce = null;

// MEMORY MANAGEMENT
function cleanup() {
  if (loadingAnimation) {
    clearInterval(loadingAnimation);
    loadingAnimation = null;
  }
  if (inputDebounce) {
    clearTimeout(inputDebounce);
    inputDebounce = null;
  }
  if (apiKeyDebounce) {
    clearTimeout(apiKeyDebounce);
    apiKeyDebounce = null;
  }
}

window.addEventListener('beforeunload', cleanup);

// ENHANCED API KEY PERSISTENCE - Multiple storage methods
function saveApiKey(key) {
  try {
    const encrypted = encryptApiKey(key);
    
    // Try multiple storage methods for better compatibility
    const storageKey = 'critique_assistant_api_key';
    
    // Method 1: localStorage (primary)
    try {
      localStorage.setItem(storageKey, encrypted);
      console.log('‚úÖ API key saved to localStorage');
    } catch (e) {
      console.warn('‚ùå localStorage failed:', e.message);
    }
    
    // Method 2: sessionStorage (fallback)
    try {
      sessionStorage.setItem(storageKey, encrypted);
      console.log('‚úÖ API key saved to sessionStorage');
    } catch (e) {
      console.warn('‚ùå sessionStorage failed:', e.message);
    }
    
    // Method 3: In-memory storage (last resort)
    window._critiqueAssistantApiKey = encrypted;
    console.log('‚úÖ API key saved to memory');
    
    return true;
  } catch (e) {
    console.error('‚ùå Failed to save API key:', e);
    return false;
  }
}

function loadApiKey() {
  try {
    const storageKey = 'critique_assistant_api_key';
    let encrypted = null;
    
    // Try multiple storage methods in order
    // Method 1: localStorage (primary)
    try {
      encrypted = localStorage.getItem(storageKey);
      if (encrypted) {
        console.log('‚úÖ API key loaded from localStorage');
      }
    } catch (e) {
      console.warn('‚ùå localStorage access failed:', e.message);
    }
    
    // Method 2: sessionStorage (fallback)
    if (!encrypted) {
      try {
        encrypted = sessionStorage.getItem(storageKey);
        if (encrypted) {
          console.log('‚úÖ API key loaded from sessionStorage');
        }
      } catch (e) {
        console.warn('‚ùå sessionStorage access failed:', e.message);
      }
    }
    
    // Method 3: In-memory storage (last resort)
    if (!encrypted && window._critiqueAssistantApiKey) {
      encrypted = window._critiqueAssistantApiKey;
      console.log('‚úÖ API key loaded from memory');
    }
    
    if (encrypted) {
      const decrypted = decryptApiKey(encrypted);
      if (decrypted && decrypted.startsWith('sk-')) {
        console.log('‚úÖ Successfully decrypted saved API key');
        return decrypted;
      } else {
        console.warn('‚ùå Failed to decrypt saved API key');
        // Clear corrupted data
        clearSavedApiKey();
      }
    } else {
      console.log('‚ÑπÔ∏è No saved API key found');
    }
  } catch (e) {
    console.error('‚ùå Failed to load API key:', e);
  }
  return '';
}

function clearSavedApiKey() {
  try {
    const storageKey = 'critique_assistant_api_key';
    
    // Clear from all storage methods
    try {
      localStorage.removeItem(storageKey);
    } catch (e) {
      console.warn('Could not clear localStorage:', e.message);
    }
    
    try {
      sessionStorage.removeItem(storageKey);
    } catch (e) {
      console.warn('Could not clear sessionStorage:', e.message);
    }
    
    delete window._critiqueAssistantApiKey;
    console.log('üßπ Cleared all saved API key data');
  } catch (e) {
    console.error('Failed to clear saved API key:', e);
  }
}

function validateApiKey(key) {
  // Updated pattern to support all OpenAI API key formats:
  // - Legacy: sk-... (20 chars)
  // - New: sk-proj-... (longer)
  // - Service: sk-svcacct-... (service accounts)
  const openaiKeyPattern = /^sk-[a-zA-Z0-9\-_]{20,}$/;
  return openaiKeyPattern.test(key);
}

function handleApiKeyInput(e) {
  clearTimeout(apiKeyDebounce);
  apiKeyDebounce = setTimeout(() => {
    const key = e.target.value.trim();
    STATE.apiKey = key;
    
    // Clear previous error
    if (DOM.apiKeyError) {
      DOM.apiKeyError.classList.add('hidden');
      DOM.apiKeyError.textContent = '';
    }
    
    if (key === '') {
      // Empty state
      DOM.apiKeyStatus.innerHTML = '<i class="fas fa-circle" style="color: var(--midnight-light);"></i>';
      DOM.apiKeyInput.classList.remove('valid', 'invalid');
      DOM.apiKeyInput.title = '';
    } else if (validateApiKey(key)) {
      // Valid key
      DOM.apiKeyStatus.innerHTML = '<i class="fas fa-check-circle"></i>';
      DOM.apiKeyStatus.className = 'api-key-status valid';
      DOM.apiKeyInput.classList.remove('invalid');
      DOM.apiKeyInput.classList.add('valid');
      DOM.apiKeyInput.title = 'Valid OpenAI API key';
      
      // Save only if remember checkbox is checked
      if (DOM.rememberApiKey && DOM.rememberApiKey.checked) {
        const saved = saveApiKey(key);
        console.log('üíæ API key save attempt:', saved ? 'Success' : 'Failed');
      } else {
        console.log('‚ÑπÔ∏è Not saving API key (remember unchecked)');
        // Clear any previously saved key if user unchecks remember
        clearSavedApiKey();
      }
      
      console.log('Valid API key detected, length:', key.length);
    } else {
      // Invalid key - provide specific feedback
      DOM.apiKeyStatus.innerHTML = '<i class="fas fa-times-circle"></i>';
      DOM.apiKeyStatus.className = 'api-key-status invalid';
      DOM.apiKeyInput.classList.remove('valid');
      DOM.apiKeyInput.classList.add('invalid');
      
      // Specific error messaging
      let errorMessage = '';
      if (!key.startsWith('sk-')) {
        errorMessage = 'API key must start with "sk-"';
      } else if (key.length < 20) {
        errorMessage = 'API key is too short (must be at least 20 characters)';
      } else if (key.includes(' ')) {
        errorMessage = 'API key should not contain spaces';
      } else {
        errorMessage = 'Invalid API key format. Should be "sk-proj-..." or "sk-..."';
      }
      
      DOM.apiKeyInput.title = errorMessage;
      if (DOM.apiKeyError) {
        DOM.apiKeyError.textContent = errorMessage;
        DOM.apiKeyError.classList.remove('hidden');
      }
      
      console.log('Invalid API key:', {
        prefix: key.substring(0, 10) + '...',
        length: key.length,
        hasSpaces: key.includes(' '),
        startsWithSk: key.startsWith('sk-'),
        error: errorMessage
      });
    }
    
    updateCTAButton();
  }, 300);
}

// INITIALIZATION WITH ENHANCED DEBUGGING
function initialize() {
  console.log('üöÄ Critique Assistant initializing...');
  
  // Test storage availability first
  testStorageAvailability();
  
  const savedKey = loadApiKey();
  console.log('üíæ Saved key found:', savedKey ? `Yes (${savedKey.length} chars)` : 'No');
  
  if (savedKey) {
    console.log('üîë Restoring saved API key...');
    DOM.apiKeyInput.value = savedKey;
    STATE.apiKey = savedKey;
    
    // Validate the loaded key
    if (validateApiKey(savedKey)) {
      DOM.apiKeyStatus.innerHTML = '<i class="fas fa-check-circle"></i>';
      DOM.apiKeyStatus.className = 'api-key-status valid';
      DOM.apiKeyInput.classList.add('valid');
      console.log('‚úÖ Saved API key is valid');
    } else {
      console.warn('‚ö†Ô∏è Saved API key failed validation, clearing...');
      clearSavedApiKey();
      DOM.apiKeyInput.value = '';
      STATE.apiKey = '';
    }
  } else {
    console.log('‚ÑπÔ∏è No saved API key, user will need to enter one');
  }
  
  setupEventListeners();
  updateUI();
  parent.postMessage({ pluginMessage: { type: 'get-initial-state' } }, '*');
  console.log('‚úÖ Critique Assistant initialized');
}

function testStorageAvailability() {
  const testKey = 'test_storage_access';
  const testValue = 'test';
  
  // Test localStorage
  try {
    localStorage.setItem(testKey, testValue);
    const retrieved = localStorage.getItem(testKey);
    localStorage.removeItem(testKey);
    console.log('‚úÖ localStorage available:', retrieved === testValue);
  } catch (e) {
    console.warn('‚ùå localStorage not available:', e.message);
  }
  
  // Test sessionStorage  
  try {
    sessionStorage.setItem(testKey, testValue);
    const retrieved = sessionStorage.getItem(testKey);
    sessionStorage.removeItem(testKey);
    console.log('‚úÖ sessionStorage available:', retrieved === testValue);
  } catch (e) {
    console.warn('‚ùå sessionStorage not available:', e.message);
  }
}

function setupEventListeners() {
  DOM.apiKeyInput.addEventListener('input', handleApiKeyInput, { passive: true });
  DOM.rememberApiKey.addEventListener('change', handleRememberCheckboxChange);
  DOM.contextInput.addEventListener('input', handleContextInputDebounced, { passive: true });
  DOM.toggleContainer.addEventListener('click', handleToggleClick);
  DOM.ctaButton.addEventListener('click', handleCTAClick);
  DOM.startOverButton.addEventListener('click', resetToPhaseOne);
  DOM.critiqueAgainButton.addEventListener('click', handleCritiqueAgain);
}

function handleRememberCheckboxChange(e) {
  const shouldRemember = e.target.checked;
  const currentKey = STATE.apiKey;
  
  if (shouldRemember && currentKey && validateApiKey(currentKey)) {
    // User wants to remember a valid key
    const saved = saveApiKey(currentKey);
    console.log('üíæ User enabled remember - saving key:', saved ? 'Success' : 'Failed');
  } else if (!shouldRemember) {
    // User doesn't want to remember - clear saved key
    clearSavedApiKey();
    console.log('üßπ User disabled remember - cleared saved key');
  }
}

function handleContextInputDebounced(e) {
  clearTimeout(inputDebounce);
  inputDebounce = setTimeout(() => {
    STATE.context = e.target.value;
    
    requestAnimationFrame(() => {
      e.target.style.height = 'auto';
      e.target.style.height = Math.min(e.target.scrollHeight, 200) + 'px';
    });
  }, 150);
}

function handleToggleClick() {
  STATE.ignoreRepeatedText = !STATE.ignoreRepeatedText;
  updateToggleButton();
}

function handleCTAClick() {
  if (!DOM.ctaButton.classList.contains('disabled')) {
    startAnalysis();
  }
}

function handleCritiqueAgain() {
  if (STATE.selectedFrames.length > 0 && STATE.apiKey) {
    startAnalysis();
  }
}

// UI UPDATES
function updateUI() {
  requestAnimationFrame(() => {
    updateFrameSelection();
    updateToggleButton();
    updateCTAButton();
    updateCritiqueAgainButton();
  });
}

function updateFrameSelection() {
  const frameCount = STATE.selectedFrames.length;
  const isValid = frameCount > 0;
  
  DOM.selectFrame.classList.toggle('frame-select-invalid', !isValid);
  DOM.selectFrame.classList.toggle('frame-select-valid', isValid);
}

function updateToggleButton() {
  DOM.toggleContainer.classList.toggle('checked', STATE.ignoreRepeatedText);
}

function updateCTAButton() {
  const hasFrames = STATE.selectedFrames.length > 0;
  const hasValidApiKey = validateApiKey(STATE.apiKey);
  const isEnabled = hasFrames && hasValidApiKey && !STATE.analysisInProgress;
  
  DOM.ctaButton.classList.toggle('disabled', !isEnabled);
  DOM.ctaButton.classList.toggle('enabled', isEnabled);
}

function updateCritiqueAgainButton() {
  const hasFrames = STATE.selectedFrames.length > 0;
  const hasValidApiKey = validateApiKey(STATE.apiKey);
  const isEnabled = hasFrames && hasValidApiKey;
  DOM.critiqueAgainButton.classList.toggle('disabled', !isEnabled);
}

// PHASE MANAGEMENT
function switchToPhase(phase) {
  STATE.currentPhase = phase;
  
  DOM.phaseOne.classList.add('hidden');
  DOM.phaseTwo.classList.add('hidden');
  DOM.phaseThree.classList.add('hidden');

  switch (phase) {
    case 'phaseOne':
      DOM.phaseOne.classList.remove('hidden');
      break;
    case 'phaseTwo':
      DOM.phaseTwo.classList.remove('hidden');
      startLoadingAnimation();
      break;
    case 'phaseThree':
      DOM.phaseThree.classList.remove('hidden');
      stopLoadingAnimation();
      break;
  }
}

// ANALYSIS
function startAnalysis() {
  if (STATE.selectedFrames.length === 0) {
    parent.postMessage({ 
      pluginMessage: { 
        type: 'show-notification',
        message: 'Please select at least one frame to analyze.'
      }
    }, '*');
    return;
  }

  if (!validateApiKey(STATE.apiKey)) {
    parent.postMessage({ 
      pluginMessage: { 
        type: 'show-notification',
        message: 'Please enter a valid OpenAI API key.'
      }
    }, '*');
    return;
  }

  STATE.analysisInProgress = true;
  updateCTAButton();
  switchToPhase('phaseTwo');
  resetLoadingStatus();

  // Request serialization from plugin
  parent.postMessage({ 
    pluginMessage: { 
      type: 'serialize-frames',
      context: STATE.context,
      ignoreRepeatedText: STATE.ignoreRepeatedText
    }
  }, '*');
}

// OPENAI API CALL
async function analyzeWithOpenAI(designData) {
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${STATE.apiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-4-turbo',
        max_tokens: 4000,
        temperature: 0.1,
        messages: [
          {
            role: 'system',
            content: UX_ANALYSIS_PROMPT
          },
          {
            role: 'user',
            content: `Design Analysis Request:

Context: ${STATE.context || 'Comprehensive UX analysis'}
Design Type: ${designData.contextAnalysis?.designType || 'interface'}
Complexity: ${designData.contextAnalysis?.complexity || 'unknown'}
User Context: ${designData.contextAnalysis?.userContext || ''}
Ignore Repeated Text: ${designData.contextAnalysis?.ignoreRepeatedText || false}

Design Data: ${JSON.stringify(designData.frames)}`
          }
        ]
      })
    });

    if (!response.ok) {
      if (response.status === 401) {
        throw new Error('Invalid API key. Please check your OpenAI API key.');
      } else if (response.status === 429) {
        throw new Error('Rate limit exceeded. Please wait a moment and try again.');
      } else if (response.status === 402) {
        throw new Error('Insufficient credits. Please add credits to your OpenAI account.');
      } else {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error?.message || `OpenAI API error: ${response.status}`);
      }
    }

    const result = await response.json();
    const content = result.choices[0]?.message?.content || '[]';
    
    const violations = parseAnalysisResult(content);
    
    showResults({
      summary: violations.length > 0 ? 
        `Found ${violations.length} UX issues` : 
        'No major issues found',
      improvements: violations,
      rawFeedback: content,
      tokensUsed: result.usage?.total_tokens || 0
    });

  } catch (error) {
    console.error('OpenAI Analysis Error:', error);
    showError(error.message || 'Analysis failed unexpectedly');
  }
}

// LOADING ANIMATION
function animateSpinner() {
  const spinnerBoxes = DOM.spinner.querySelectorAll('.spinner-box');
  let activeIndex = 0;

  loadingAnimation = setInterval(() => {
    spinnerBoxes[activeIndex]?.classList.remove('active');
    activeIndex = (activeIndex + 1) % spinnerBoxes.length;
    spinnerBoxes[activeIndex]?.classList.add('active');
  }, 350);
}

function startLoadingAnimation() {
  if (!loadingAnimation) {
    animateSpinner();
  }

  const statusProgression = [
    { element: DOM.status1, delay: 200, duration: 400 },
    { element: DOM.status2, delay: 800, duration: 600 },
    { element: DOM.status3, delay: 1600, duration: 800 },
    { element: DOM.status4, delay: 2600, duration: 0 }
  ];

  statusProgression.forEach(({ element, delay, duration }) => {
    setTimeout(() => {
      element.classList.remove('waiting');
      element.classList.add('in-progress');
      
      if (duration > 0) {
        setTimeout(() => {
          element.classList.remove('in-progress');
          element.classList.add('complete');
        }, duration);
      }
    }, delay);
  });
}

function stopLoadingAnimation() {
  if (loadingAnimation) {
    clearInterval(loadingAnimation);
    loadingAnimation = null;
  }
  
  DOM.spinner.querySelectorAll('.spinner-box').forEach(box => {
    box.classList.remove('active');
  });
}

function resetLoadingStatus() {
  [DOM.status1, DOM.status2, DOM.status3, DOM.status4].forEach(item => {
    item.className = 'status-item waiting';
  });
}

function parseAnalysisResult(result) {
  if (!result) return [];
  
  try {
    if (typeof result === 'string') {
      if (result.trim() === '' || result === '[]') return [];
      
      const parsed = JSON.parse(result);
      return Array.isArray(parsed) ? parsed : [];
    }
    
    if (Array.isArray(result)) {
      return result;
    }
    
    if (result.improvements && Array.isArray(result.improvements)) {
      return result.improvements;
    }
    
    return [];
  } catch (parseError) {
    console.error('Parse error:', parseError);
    return [];
  }
}

function showResults(result) {
  STATE.analysisInProgress = false;
  DOM.status4.classList.remove('in-progress');
  DOM.status4.classList.add('complete');

  setTimeout(() => {
    switchToPhase('phaseThree');
    populateResults(result);
    updateUI();
  }, 600);
}

// VIOLATION CARD CREATION
function createViolationCard(violation) {
  const card = document.createElement('div');
  card.className = 'violation-card';

  const header = document.createElement('div');
  header.className = 'violation-card-header';

  const headerLeft = document.createElement('div');
  headerLeft.className = 'violation-header-left';

  const titleElement = document.createElement('h3');
  titleElement.className = 'violation-title';
  titleElement.textContent = violation.title || 'Usability Issue';

  const metaDiv = document.createElement('div');
  metaDiv.className = 'violation-meta';

  if (violation.severity) {
    const severityBadge = document.createElement('span');
    severityBadge.className = `severity-badge severity-${violation.severity}`;
    severityBadge.textContent = violation.severity.toUpperCase();
    metaDiv.appendChild(severityBadge);
  }

  const tenetName = extractTenetFromPrinciple(violation.principleViolation);
  if (tenetName) {
    const tenetBadge = document.createElement('span');
    tenetBadge.className = 'tenet-badge';
    tenetBadge.textContent = tenetName;
    metaDiv.appendChild(tenetBadge);
  }

  headerLeft.appendChild(titleElement);
  headerLeft.appendChild(metaDiv);

  const headerRight = document.createElement('div');
  headerRight.className = 'violation-header-right';

  const focusButton = document.createElement('button');
  focusButton.className = 'focus-button';
  focusButton.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i>';
  
  focusButton._violationData = {
    title: violation.title,
    description: violation.description,
    location: violation.location,
    userImpact: violation.userImpact,
    recommendation: violation.recommendation,
    searchTerms: extractSearchTerms(violation)
  };
  
  focusButton.addEventListener('click', handleFocusButtonClick);

  headerRight.appendChild(focusButton);
  header.appendChild(headerLeft);
  header.appendChild(headerRight);

  const content = document.createElement('div');
  content.className = 'violation-content';

  if (violation.principleViolation) {
    const summaryP = document.createElement('p');
    summaryP.className = 'violation-summary';
    summaryP.innerHTML = `<strong>${extractTrapFromPrinciple(violation.principleViolation)}:</strong> ${extractTrapDescription(violation.principleViolation)}`;
    content.appendChild(summaryP);
  }

  if (violation.description) {
    const descP = document.createElement('p');
    descP.className = 'violation-details';
    descP.innerHTML = `<strong>Description:</strong> ${violation.description}`;
    content.appendChild(descP);
  }

  if (violation.userImpact) {
    const impactP = document.createElement('p');
    impactP.className = 'violation-impact';
    impactP.innerHTML = `<strong>Impact:</strong> ${violation.userImpact}`;
    content.appendChild(impactP);
  }

  if (violation.recommendation) {
    const recP = document.createElement('p');
    recP.className = 'violation-recommendation';
    recP.innerHTML = `<strong>Recommendation:</strong> ${violation.recommendation}`;
    content.appendChild(recP);
  }

  card.appendChild(header);
  card.appendChild(content);
  return card;
}

function handleFocusButtonClick(e) {
  e.preventDefault();
  e.stopPropagation();
  
  const button = e.currentTarget;
  const violationData = button._violationData;
  
  if (!violationData) {
    parent.postMessage({ 
      pluginMessage: { 
        type: 'show-notification',
        message: 'No focus data available'
      }
    }, '*');
    return;
  }

  button.classList.add('processing');
  
  parent.postMessage({ 
    pluginMessage: {
      type: 'focus-violation-area-optimized',
      violationContext: violationData
    }
  }, '*');
  
  setTimeout(() => {
    button.classList.remove('processing');
  }, 1500);
}

// HELPER FUNCTIONS
function extractSearchTerms(violation) {
  const terms = new Set();
  
  if (violation.location) {
    violation.location.split(' > ').forEach(part => {
      const clean = part.trim().toLowerCase();
      if (clean.length > 2 && !isStopWord(clean)) {
        terms.add(clean);
      }
    });
  }
  
  [violation.title, violation.description].forEach(text => {
    if (text) {
      const uiPattern = /\b(button|input|field|menu|nav|form|card|modal|dropdown|checkbox|radio|tab|link|icon|frame|group|section|header|footer|sidebar)\b/gi;
      const matches = text.match(uiPattern);
      if (matches) {
        matches.forEach(match => terms.add(match.toLowerCase()));
      }
      
      const quotedPattern = /"([^"]{2,25})"/g;
      let match;
      while ((match = quotedPattern.exec(text)) !== null) {
        terms.add(match[1].toLowerCase());
      }
    }
  });
  
  return Array.from(terms).slice(0, 5);
}

function isStopWord(word) {
  return ['the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by'].includes(word);
}

function extractTenetFromPrinciple(principleText) {
  if (!principleText) return null;
  
  const tenets = ['Understandable', 'Habituating', 'Comfortable', 'Responsive', 'Efficient', 'Forgiving', 'Discreet', 'Protective', 'Beautiful'];
  
  for (const tenet of tenets) {
    if (principleText.includes(tenet)) {
      return tenet;
    }
  }
  
  return null;
}

function extractTrapFromPrinciple(principleText) {
  if (!principleText) return 'Usability Issue';
  
  const traps = [
    'Memory Challenge', 'Forced Syntax', 'Inviting Dead End', 'Uncomprehended Element',
    'Invisible Element', 'Poor Grouping', 'Feedback Failure', 'Distraction',
    'Effectively Invisible Element', 'Ambiguous Home', 'Gratuitous Redundancy',
    'Inconsistent Appearance', 'Variable Outcome', 'Wandering Element',
    'Physical Challenge', 'Accidental Activation', 'Slow or No Response',
    'Captive Wait', 'Unnecessary Step', 'System Amnesia', 'Irreversible Action',
    'Unwanted Disclosure', 'Data Loss', 'Unattractive Appearance'
  ];
  
  for (const trap of traps) {
    if (principleText.includes(trap)) {
      return trap;
    }
  }
  
  return 'Usability Issue';
}

function extractTrapDescription(principleText) {
  if (!principleText) return 'Critical relationship between noticeable cues is not obvious.';
  
  const match = principleText.match(/[^:]+:\s*(.+)/);
  if (match && match[1]) {
    return match[1].trim();
  }
  
  return 'Critical relationship between noticeable cues is not obvious.';
}

function populateResults(result) {
  try {
    const fragment = document.createDocumentFragment();

    if (result.error) {
      const errorCard = createResultCard({
        title: 'Analysis Error',
        content: result.error,
        type: 'error'
      });
      fragment.appendChild(errorCard);
      DOM.resultsContent.replaceChildren(fragment);
      return;
    }

    let violations = [];

    if (result.rawFeedback) {
      try {
        const parsed = typeof result.rawFeedback === 'string' 
          ? JSON.parse(result.rawFeedback)
          : result.rawFeedback;
        violations = Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.error('Failed to parse JSON response:', e);
        violations = result.improvements || [];
      }
    } else if (result.improvements && Array.isArray(result.improvements)) {
      violations = result.improvements;
    }

    if (violations.length > 0) {
      violations.forEach(violation => {
        const card = createViolationCard(violation);
        fragment.appendChild(card);
      });
    } else {
      const successCard = createResultCard({
        title: 'Great work!',
        content: 'No significant usability issues found in your design.',
        type: 'nothing-returned'
      });
      fragment.appendChild(successCard);
    }

    DOM.resultsContent.replaceChildren(fragment);
  } catch (error) {
    console.error('Results population error:', error);
    const errorCard = createResultCard({
      title: 'Display Error', 
      content: 'Failed to display results properly. Please try again.',
      type: 'error'
    });
    DOM.resultsContent.appendChild(errorCard);
  }
}

function createResultCard({ title, content, type = 'normal' }) {
  const card = document.createElement('div');
  card.className = `results-card ${type}`;

  const header = document.createElement('header');
  header.className = 'results-card-header';

  const h3 = document.createElement('h3');
  h3.textContent = title;
  header.appendChild(h3);

  const contentDiv = document.createElement('div');
  contentDiv.className = 'content';
  const p = document.createElement('p');
  p.textContent = content;
  contentDiv.appendChild(p);
  
  card.appendChild(header);
  card.appendChild(contentDiv);
  return card;
}

function showError(error) {
  STATE.analysisInProgress = false;
  updateUI();

  if (STATE.currentPhase === 'phaseOne') {
    parent.postMessage({ 
      pluginMessage: { 
        type: 'show-notification',
        message: error
      }
    }, '*');
    return;
  }

  switchToPhase('phaseThree');
  showResults({ error: error });
}

function resetToPhaseOne() {
  STATE.analysisInProgress = false;
  STATE.context = '';
  STATE.ignoreRepeatedText = false;

  DOM.contextInput.value = '';
  DOM.contextInput.style.height = 'auto';
  updateUI();
  switchToPhase('phaseOne');
}

// MESSAGE HANDLING
window.onmessage = (event) => {
  if (!event.data?.pluginMessage) return;

  const message = event.data.pluginMessage;

  try {
    switch (message.type) {
      case 'selection-changed':
        requestAnimationFrame(() => {
          STATE.selectedFrames = message.frames || [];
          updateFrameSelection();
          updateCTAButton();
          updateCritiqueAgainButton();
        });
        break;
      case 'serialization-complete':
        analyzeWithOpenAI(message.designData);
        break;
      case 'serialization-error':
        showError(message.error);
        break;
      default:
        console.warn('Unknown message type:', message.type);
    }
  } catch (error) {
    console.error('Message handling error:', error);
    showError('An unexpected error occurred. Please try again.');
  }
};

// ERROR HANDLING
window.onerror = (msg, url, line, col, error) => {
  console.error('UI Error:', { msg, line, col, error });
  showError('A user interface error occurred. Please restart the plugin.');
  return true;
};

window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event.reason);
  showError('An unexpected error occurred. Please try again.');
});

// INITIALIZE
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initialize);
} else {
  initialize();
}
    </script>
</body>
</html>